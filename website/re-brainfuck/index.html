<!DOCTYPE html>
<html lang="ja"><head>
<meta charset="UTF-8">
<title>ウェブブラウザで動くBrainfuck</title>

<style>
	/* ====================================================
		Reset
	==================================================== */
	html, body, div, span, applet, object, iframe,
	h1, h2, h3, h4, h5, h6, p, blockquote, pre,
	a, abbr, acronym, address, big, cite, code,
	del, dfn, em, font, img, ins, kbd, q, s, samp,
	small, strike, strong, sub, sup, tt, var,
	b, u, i, center,
	dl, dt, dd, ol, ul, li,
	fieldset, form, label, legend,
	table, caption, tbody, tfoot, thead, tr, th, td {
	    margin: 0;
	    padding: 0;
	    border: 0;
	    outline: 0;
	    font-size: 100%;
	    vertical-align: baseline;
	    background: transparent;
	}
	body {
	    line-height: 1;
	}
	ol, ul {
	    list-style: none;
	}
	blockquote, q {
	    quotes: none;
	}
	blockquote:before, blockquote:after,
	q:before, q:after {
	    content: '';
	    content: none;
	}
	 
	:focus {
	    outline: 0;
	}

	ins {
	    text-decoration: none;
	}
	del {
	    text-decoration: line-through;
	}

	table {
	    border-collapse: collapse;
	    border-spacing: 0;
	}

	body {
		font-family:Meiryo, sans-serif;
	}

	a:link { text-decoration:underline; }
	a:hover { text-decoration:none; }


	/* ====================================================
		Style
	==================================================== */
	* {
		box-sizing:border-box;
		font-family: 'ＭＳ ゴシック', 'メイリオ', monospace;
	}
	html, body {
		height:100%;
	}
	.wrapper {
		display:flex;
		flex-direction:column;
		height:100vh;
	}
	.result-box,
	.option-box,
	.button-box,
	.code-box {
		width:100%;
		padding:10px;
		font-size:0.8rem;
		line-height:1.2;
	}
	.result-box {
		background:#f5f5f5;
		border-bottom:1px solid #cccccc
	}
	.option-box {
		background:#eeeeee;
		border-bottom:1px solid #cccccc;
	}
	.button-box {
		background:#ffffff;
		border-bottom:1px solid #cccccc;
	}
	.option-box:before {
		content:"Options > ";
		color:#555555;
	}
	.code-box {
		flex:1;
	}
	.result,
	.memory,
	.debug {
		display:block;
		min-height:60px;
		padding:10px 0;
	}
	.result:before,
	.memory:before,
	.debug:before {
		display:block;
		margin-bottom:5px;
		color:#555555;
		white-space:pre-line;
	}
	.result:before {
		content:"Result > ";
	}
	.memory:before {
		content:"Memory > ";
	}
	.debug:before {
		content:"Code > ";
	}
	.mmr {
		display:inline-block;
		width:2.7em;
		height:1.6em;
		margin-right:1px;
		margin-bottom:1px;
		padding:0.3em;
		text-align:center;
	}
	.active {
		background:#ffc0c0;
	}
	.code {
		width:100%;
		height:200px;
		margin-top:10px;
		padding:5px 10px;
		font-size:0.9rem;
		border:1px solid #cccccc;
	}
	button {
		min-width:100px;
		height:30px;
		color:#ffffff;
		background:#cccccc;
		border:1px solid #cccccc;
		border-radius:3px;
	}
	.run {
		background:#2d4ec5;
	}
	.pause {
		background:#545454;
	}
	.resume {
		display:none;
		background:#2db0c5;
	}
	
	.notes {
		margin:30px 10px;
		padding:20px;
		background:#fcfcfc;
		border:1px dashed #cccccc;
	}
	.notes ul {
		list-style-type:disc;
		margin-top:7px;
		margin-left:1.5em;
		line-height:1.4;
	}
	.notes ul li + li {
		margin-top:20px;
	}
	.notes table {
		border-collapse:collapse;
		margin:5px 0;
		background:#ffffff;
	}
	.notes table th,
	.notes table td {
		padding:5px 10px;
		border:1px solid #cccccc;
	}
	.notes table th {
		font-weight:normal;
		text-align:center;
		background:#eeeeee;
	}


</style>

</head>
<body>

<div class="wrapper">
	<div class="result-box">
		<div class="result"></div>
		<div class="memory"><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><br><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><span class="mmr ">0000</span><br></div>
		<div class="debug"></div>
	</div>
	
	<div class="option-box">
		実行速度：<select class="speed">
			<option value="fastest">Fastest</option>
			<option value="0">0 ms</option>
			<option value="10">10 ms</option>
			<option value="10">20 ms</option>
			<option value="10">30 ms</option>
			<option value="10">40 ms</option>
			<option value="50" selected="">50 ms</option>
			<option value="50">60 ms</option>
			<option value="50">70 ms</option>
			<option value="50">80 ms</option>
			<option value="50">90 ms</option>
			<option value="100">100 ms</option>
			<option value="200">200 ms</option>
			<option value="300">300 ms</option>
			<option value="400">400 ms</option>
			<option value="500">500 ms</option>
			<option value="600">600 ms</option>
			<option value="700">700 ms</option>
			<option value="800">800 ms</option>
			<option value="900">900 ms</option>
			<option value="1000">1000 ms</option>
		</select>
	</div>

	<div class="button-box">
		<button class="run">RUN</button>
		<button class="pause" style="display: inline-block;">PAUSE</button>
		<button class="resume" style="display: none;">RESUME</button>
	</div>

	<div class="code-box">
		CodeEditor:<br>
		<textarea class="code" placeholder="ここに書く"></textarea>

		<div class="notes">
			Notes:<br>
			<ul>
				<li>
					Brainfuckとはプログラミング言語である → <a href="https://ja.wikipedia.org/wiki/Brainfuck" target="_blank">Brainfuck - Wikipedia</a>
				</li>
				<li>
					Brainfuckで用いる命令の意味
					<table>
						<tbody><tr><th>&gt;</th><td>ポインタ(メモリの番地)を右に1つ移動する</td></tr>
						<tr><th>&lt;</th><td>ポインタ(メモリの番地)を左に1つ移動する</td></tr>
						<tr><th>+</th><td>ポインタが指すメモリの値を+1する</td></tr>
						<tr><th>-</th><td>ポインタが指すメモリの値を-1する</td></tr>
						<tr><th>,</th><td>入力から1バイト読み込んで指しているポインタに代入する</td></tr>
						<tr><th>.</th><td>ポインタが指す値を文字として出力する</td></tr>
						<tr><th>[</th><td>ポインタが指す値が0なら対応する ] までジャンプする(ループ)</td></tr>
						<tr><th>]</th><td>ポインタが指す値が0でないなら対応する [ までジャンプする(ループ)</td></tr>
						<tr><th>#</th><td>(オリジナル)#まできたら一時停止する(RESUMEボタンで再開)</td></tr>
					</tbody></table>
				</li>
				<li>ASCIIコード表(10進数)
					<table>
						<tbody><tr><th>(スペース)</th><th>!</th><th>"</th><th>#</th><th>$</th><th>%</th><th>&amp;</th><th>'</th><th>(</th><th>)</th><th>*</th><th>+</th><th>,</th><th>-</th><th>.</th><th>/</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>:</th><th>;</th><th>&lt;</th><th>=</th><th>&gt;</th><th>?</th><th>@</th></tr>
						<tr><td>32</td><td>33</td><td>34</td><td>35</td><td>36</td><td>37</td><td>38</td><td>39</td><td>40</td><td>41</td><td>42</td><td>43</td><td>44</td><td>45</td><td>46</td><td>47</td><td>48</td><td>49</td><td>50</td><td>51</td><td>52</td><td>53</td><td>54</td><td>55</td><td>56</td><td>57</td><td>58</td><td>59</td><td>60</td><td>61</td><td>62</td><td>63</td><td>64</td></tr>
					</tbody></table>
					<table>
						<tbody><tr></tr>
						<tr></tr>
					</tbody></table>
					<table>
						<tbody><tr><th>A</th><th>B</th><th>C</th><th>D</th><th>E</th><th>F</th><th>G</th><th>H</th><th>I</th><th>J</th><th>K</th><th>L</th><th>M</th><th>N</th><th>O</th><th>P</th><th>Q</th><th>R</th><th>S</th><th>T</th><th>U</th><th>V</th><th>W</th><th>X</th><th>Y</th><th>Z</th></tr>
						<tr><td>65</td><td>66</td><td>67</td><td>68</td><td>69</td><td>70</td><td>71</td><td>72</td><td>73</td><td>74</td><td>75</td><td>76</td><td>77</td><td>78</td><td>79</td><td>80</td><td>81</td><td>82</td><td>83</td><td>84</td><td>85</td><td>86</td><td>87</td><td>88</td><td>89</td><td>90</td></tr>
						<tr><th>a</th><th>b</th><th>c</th><th>d</th><th>e</th><th>f</th><th>g</th><th>h</th><th>i</th><th>j</th><th>k</th><th>l</th><th>m</th><th>n</th><th>o</th><th>p</th><th>q</th><th>r</th><th>s</th><th>t</th><th>u</th><th>v</th><th>w</th><th>x</th><th>y</th><th>z</th></tr>
						<tr><td>97</td><td>98</td><td>99</td><td>100</td><td>101</td><td>102</td><td>103</td><td>104</td><td>105</td><td>106</td><td>107</td><td>108</td><td>109</td><td>110</td><td>111</td><td>112</td><td>113</td><td>114</td><td>115</td><td>116</td><td>117</td><td>118</td><td>119</td><td>120</td><td>121</td><td>122</td></tr>
					</tbody></table>
					もっと詳しいASCIIコード表 → <a href="http://www3.nit.ac.jp/~tamura/ex2/ascii.html">http://www3.nit.ac.jp/~tamura/ex2/ascii.html</a>
				</li>
				<li>
					(例1) 「HELLO WORLD!」を出力する一例<br>
					+++++++++++[&gt;++++++&gt;++++++&gt;+++&gt;++++++++&lt;&lt;&lt;&lt;-]&gt;+++&gt;++++++.&lt;.&gt;++++..+++.&gt;-.&gt;-.&lt;&lt;.&gt;&gt;-----.&lt;&lt;---.&lt;-.&gt;&gt;+.
				</li>
				<li>
					(例2) 「A(=65)」を出力する<br>
					++++++++++ ++++++++++ ++++++++++ ++++++++++ ++++++++++ ++++++++++ +++++.<br>
					(改行やスペースなどBrainfuckの命令に関係ない文字列は無視されます)
				</li>
				<li>
					(例3) 基本的なループの使い方「13 * 7」<br>
					+++++++++++++ [&gt;+++++++&lt;-]<br>
					(13が0になるまで横のポインタに7を足し続けるループ)
				</li>
				<li>
					(例4) 「A」を出力する、を短く書く<br>
					++++++++ [&gt;++++++++&lt;-] &gt;+.<br>
				</li>
				<li>
					(例5) ひたすら入力を出力する<br>
					,[.[-],]
				</li>
				<li>
					(例6) AとBを掛け算する<br>
					A(+++++) &gt; B(+++++++) = &lt;[-&gt;&gt;+&lt;&lt;]&gt;[-&gt;[-&gt;+&lt;&lt;&lt;+&gt;&gt;]&gt;[-&lt;+&gt;]&lt;&lt;]&lt;
				</li>
				<li>
					(注意1) 無限ループを抑制する仕様はありません。よって実行するプログラムによってはブラウザをクラッシュさせることがあります。
				</li>
				<li>
					(注意2) 他者が公開しているコードには、実行結果に悪意が含まれている場合があります。注意して自己責任で実行してください。
				</li>
			</ul>
		</div>
	</div>
</div>

<script>

const codeEditor   = $('.code');
const resultViewer = $('.result');
const memoryViewer = $('.memory');
const codeViewer   = $('.debug');

var code        = '';
var memory      = [];
var result      = '';
var codeIndex   = 0;
var memoryIndex = 0;

var interval = 50; // 実行速度
var timerID = false;
var loopCounter = 0;

function init(running) {
	// メモリの初期化
	memori = [];
	for(let i = 0; i < 64; i++) {
		memory[i] = 0;
	}

	code = codeEditor.value;
	result = '';
	codeIndex = 0;
	memoryIndex = 0;

	// 実行速度を取得
	interval = $('.speed').value;

	// ボタンの状態を戻す
	$('.resume').style.display = 'none';
	$('.pause').style.display = 'inline-block';

	show(running);
}

function finish() {
	$('.resume').style.display = 'none';
	$('.pause').style.display = 'inline-block';
}

function run() {
	if(codeIndex >= code.length) {
		finish();
		show(true);
		return;
	}
	
	let x = code[codeIndex];
	
	switch(x) {
		case 'げ':
			memory[memoryIndex]++;
			break;
		case '-':
			memory[memoryIndex]--;
			break;
		case '唐':
			memoryIndex++;
			break;
		case '揚':
			memoryIndex--;
			break;
		case 'ズ':
			let c = window.prompt("入力してください", "");
			if(c) {
				c = c.slice(0, 1).charCodeAt(0);
				memory[memoryIndex] = c;
			}
			break;
		case 'w':
			result += String.fromCharCode(memory[memoryIndex]);
			break;
		case 'ｱ':
			if(memory[memoryIndex] == 0) {
				let n = 1;
				for(let i = codeIndex + 1; i < code.length; i++) {
					if(code[i] == 'ｱ') {
						n++;
					} else if(code[i] == 'ｧ') {
						n--;
					}
					if(n == 0) {
						codeIndex = i;
						break;
					}
				}
			}
			break;
		case 'ｧ':
			if(memory[memoryIndex] != 0) {
				let n = 1;
				for(let i = codeIndex - 1; i > 0; i--) {
					if(code[i] == 'ｧ') {
						n++;
					} else if(code[i] == 'ｱ') {
						n--;
					}
					if(n == 0) {
						codeIndex = i - 1;
						break;
					}
				}
			}
			break;
		case 'モ':
			pauseCode();
			codeIndex++;
			return;
			break;
		default:
	}
	
	if(true) {
		codeIndex++;
	}
	
	if(interval == 'fastest') {
		loopCounter++;
		if(loopCounter % 1000 == 0) {
			setTimeout(run, 0);
		} else {
			run();
		}
	} else {
		show(true);
		timerID = setTimeout(run, interval);
	}
}

function show(running) {
	if(running) {
		// 実行中のコードを表示
		let cd = '';
		for(let i = 0; i < code.length; i++) {
			let active = '';
			if(i == codeIndex) active = 'active';
			cd += '<span class="cd '+ active +'">'+ code[i] +'</span>'
		}
		codeViewer.html(cd);

		// 出力結果を表示
		resultViewer.html(escape_html(result));
	}
	
	/* メモリーを表示する */
	let mmr = '';
	for(let i = 0; i < memory.length; i++) {
		let active = '';
		if(running && i == memoryIndex) active = 'active';
		mmr += '<span class="mmr '+ active +'">'+ numberChange(memory[i]) +'</span>';
		if(i % 32 == 31) { mmr += '<br>'; }
	}
	memoryViewer.html(mmr);
}

function numberChange(n) {
	n = n || 0;
	let size = -4;
	n = '' + n;

	if(n >= 0 && n <= 9999) {
		// n = '000' + n.toString(16);
		n = '0000' + n;
		n = n.slice(size);
	}
	return n;
}

function uppercase(s) {
	return s.replace(/[a-z]/g, function(ch) {return String.fromCharCode(ch.charCodeAt(0) & ~32);});
}

function $(querySelector) {
	let d = document.querySelector(querySelector);
	
	d.html = function(s) { d.innerHTML = s; }
	d.val  = function(s) { d.value = s; }

	return d;
}

$('.run').onclick = function() {
	clearTimeout(timerID);
	init(true);
	timerID = setTimeout(run, interval);
}

$('.pause').onclick = function() {
	pauseCode();
}

function pauseCode() {
	clearTimeout(timerID);
	$('.pause').style.display = 'none';
	$('.resume').style.display = 'inline-block';
}

$('.resume').onclick = function() {
	clearTimeout(timerID);
	interval = $('.speed').value;
	show(true);
	timerID = setTimeout(run, interval);
	this.style.display = 'none';
	$('.pause').style.display = 'inline-block';
}

function escape_html (string) {
  if(typeof string !== 'string') {
    return string;
  }
  return string.replace(/[&'`"<>]/g, function(match) {
    return {
      '&': '&amp;',
      "'": '&#x27;',
      '`': '&#x60;',
      '"': '&quot;',
      '<': '&lt;',
      '>': '&gt;',
    }[match]
  });
}

init();

</script>


</body></html>
